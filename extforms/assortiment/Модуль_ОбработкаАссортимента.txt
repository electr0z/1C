Перем тЦен Экспорт;

Функция ТаблицаВсехЦены()Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ТоматоЗафиксированныеЦеныПоставщика.Контрагент КАК Поставщик,
	               |	ТоматоЗафиксированныеЦеныПоставщика.Номенклатура КАК НоменклатураПоставщика,
	               |	ТоматоЗафиксированныеЦеныПоставщика.Период КАК Период,
	               |	ТоматоЗафиксированныеЦеныПоставщика.НоменклатураРаруса,
	               |	ТоматоЗафиксированныеЦеныПоставщика.Организация КАК Организация,
	               |	ТоматоЗафиксированныеЦеныПоставщика.Цена
	               |ИЗ
	               |	РегистрСведений.ТоматоЗафиксированныеЦеныПоставщика КАК ТоматоЗафиксированныеЦеныПоставщика
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	НоменклатураПоставщика,
	               |	Период УБЫВ
	               |АВТОУПОРЯДОЧИВАНИЕ";
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ТаблицаЦеныДляТЧ()Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Организация,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Период
	               |ПОМЕСТИТЬ ВТЦеныБудущего
	               |ИЗ
	               |	РегистрСведений.ТоматоЗафиксированныеЦеныПоставщика.СрезПоследних(&ДатаБудущего, ) КАК ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних
	               |ГДЕ
	               |	ВЫБОР
	               |			КОГДА &Контрагент <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент = &Контрагент
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |	И ВЫБОР
	               |			КОГДА &Номенклатура <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса = &Номенклатура
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |	И ВЫБОР
	               |			КОГДА &Организация <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Организация = &Организация
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Период,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Комментарий,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Цена,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.ЭтоИсключение
	               |ПОМЕСТИТЬ ВТЦеныСреднегоУровня
	               |ИЗ
	               |	РегистрСведений.ТоматоЗафиксированныеЦеныПоставщика.СрезПоследних(&ТекДата, ) КАК ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних
	               |ГДЕ
	               |	ВЫБОР
	               |			КОГДА &Контрагент <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент = &Контрагент
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |	И ВЫБОР
	               |			КОГДА &Номенклатура <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса = &Номенклатура
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |	И ВЫБОР
	               |			КОГДА &Организация <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Организация = &Организация
	               |			ИНАЧЕ НЕ ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.ЭтоИсключение
	               |		КОНЕЦ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ГрафикЗаказа.Организация,
	               |	ГрафикЗаказа.ГруппаЗаказа,
	               |	ГруппыЗаказовГруппаНоменклатуры.НоменклатураПоставщика,
	               |	ЕСТЬNULL(ГруппыЗаказовГруппаНоменклатуры.НоменклатураПоставщика.НоменкалтураИзРаруса, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК НоменклатураРаруса,
	               |	ЕСТЬNULL(ГрафикЗаказа.ГруппаЗаказа.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)) КАК Контрагент
	               |ПОМЕСТИТЬ ВТГрафикЗаказа
	               |ИЗ
	               |	РегистрСведений.ГрафикЗаказовИПоставокПраздничный КАК ГрафикЗаказа
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ГруппыЗаказов.ГруппаНоменклатуры КАК ГруппыЗаказовГруппаНоменклатуры
	               |		ПО ГрафикЗаказа.ГруппаЗаказа = ГруппыЗаказовГруппаНоменклатуры.Ссылка
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ГруппыЗаказовГруппаНоменклатуры.НоменклатураПоставщика,
	               |	ГрафикЗаказа.Организация,
	               |	ГрафикЗаказа.ГруппаЗаказа,
	               |	ЕСТЬNULL(ГруппыЗаказовГруппаНоменклатуры.НоменклатураПоставщика.НоменкалтураИзРаруса, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)),
	               |	ЕСТЬNULL(ГрафикЗаказа.ГруппаЗаказа.Контрагент, ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ЛОЖЬ КАК Выбран,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Организация КАК Организация,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент КАК Поставщик,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура КАК Номенклатура,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса КАК НоменклатураРаруса,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Цена КАК ЦенаВРесторане,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ВТЦеныСреднегоУровня.Цена, 0) <> 0
	               |			ТОГДА ВТЦеныСреднегоУровня.Цена / ВЫБОР
	               |					КОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчета = 0
	               |						ТОГДА 1
	               |					ИНАЧЕ ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчета
	               |				КОНЕЦ
	               |		ИНАЧЕ 0
	               |	КОНЕЦ КАК ЦенаЗаШтуку,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчета, 0) = 0
	               |			ТОГДА ВЫБОР
	               |					КОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.ИспользоватьКратностьПоставки
	               |						ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КратностьПоставки
	               |					ИНАЧЕ 1
	               |				КОНЕЦ
	               |		ИНАЧЕ ВЫБОР
	               |				КОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.ИспользоватьКратностьПоставки
	               |					ТОГДА 1 / ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчета * ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КратностьПоставки
	               |				ИНАЧЕ 1 / ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчета
	               |			КОНЕЦ
	               |	КОНЕЦ КАК ЧистыйВес,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КраткоеНаименование КАК Фасовка,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчетаКгЛ КАК КоэффПеревода,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Комментарий КАК Комментарий,
	               |	ВЫБОР
	               |		КОГДА НЕ ВТЦеныБудущего.Период ЕСТЬ NULL
	               |			ТОГДА ВЫБОР
	               |					КОГДА ВТЦеныБудущего.Период <> ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Период
	               |						ТОГДА ИСТИНА
	               |					ИНАЧЕ ЛОЖЬ
	               |				КОНЕЦ
	               |		ИНАЧЕ ЛОЖЬ
	               |	КОНЕЦ КАК ЕстьИзмененияВБудущемПериоде,
	               |	ЕСТЬNULL(ВТЦеныСреднегоУровня.Цена, 0) КАК Цена,
	               |	ЕСТЬNULL(ВТЦеныСреднегоУровня.Комментарий, """") КАК КомментарийСУ,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.ЭтоИсключение КАК Исключение,
	               |	ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.ЭтоИсключение КАК ИсключениеСУ,
	               |	ЕСТЬNULL(ВТЦеныСреднегоУровня.Цена, 0) / ВЫБОР
	               |		КОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчета = 0
	               |			ТОГДА 1
	               |		ИНАЧЕ ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КоэффициентПересчета
	               |	КОНЕЦ * ВЫБОР
	               |		КОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.ИспользоватьКратностьПоставки
	               |			ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура.КратностьПоставки
	               |		ИНАЧЕ 1
	               |	КОНЕЦ КАК ЦенаЗаШтукуСУ,
	               |	ВЫБОР
	               |		КОГДА НЕ ВТЦеныБудущего.Период ЕСТЬ NULL
	               |			ТОГДА ВЫБОР
	               |					КОГДА ВТЦеныБудущего.Период <> ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Период
	               |						ТОГДА ИСТИНА
	               |					ИНАЧЕ ЛОЖЬ
	               |				КОНЕЦ
	               |		ИНАЧЕ ЛОЖЬ
	               |	КОНЕЦ КАК ЕстьИзмененияВБудущемПериодеСУ,
	               |	ЕСТЬNULL(ВТГрафикЗаказа.ГруппаЗаказа, ЗНАЧЕНИЕ(Справочник.ГруппыЗаказов.ПустаяСсылка)) КАК ГруппаЗаказа
	               |ИЗ
	               |	РегистрСведений.ТоматоЗафиксированныеЦеныПоставщика.СрезПоследних(&ТекДата, ) КАК ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТЦеныБудущего КАК ВТЦеныБудущего
	               |		ПО ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент = ВТЦеныБудущего.Контрагент
	               |			И ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса = ВТЦеныБудущего.НоменклатураРаруса
	               |			И ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура = ВТЦеныБудущего.Номенклатура
	               |			И ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Организация = ВТЦеныБудущего.Организация
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТЦеныСреднегоУровня КАК ВТЦеныСреднегоУровня
	               |		ПО ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура = ВТЦеныСреднегоУровня.Номенклатура
	               |			И ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса = ВТЦеныСреднегоУровня.НоменклатураРаруса
	               |			И ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент = ВТЦеныСреднегоУровня.Контрагент
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТГрафикЗаказа КАК ВТГрафикЗаказа
	               |		ПО ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент = ВТГрафикЗаказа.Контрагент
	               |			И ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Номенклатура = ВТГрафикЗаказа.НоменклатураПоставщика
	               |			И ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Организация = ВТГрафикЗаказа.Организация
	               |ГДЕ
	               |	ВЫБОР
	               |			КОГДА &Контрагент <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Контрагент = &Контрагент
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |	И ВЫБОР
	               |			КОГДА &Номенклатура <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.НоменклатураРаруса = &Номенклатура
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |	И ВЫБОР
	               |			КОГДА &Организация <> НЕОПРЕДЕЛЕНО
	               |				ТОГДА ТоматоЗафиксированныеЦеныПоставщикаСрезПоследних.Организация = &Организация
	               |			ИНАЧЕ ИСТИНА
	               |		КОНЕЦ
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Поставщик,
	               |	Номенклатура,
	               |	Организация,
	               |	ЦенаВРесторане
	               |ИТОГИ
	               |	МАКСИМУМ(НоменклатураРаруса),
	               |	МАКСИМУМ(ЧистыйВес),
	               |	МАКСИМУМ(Фасовка),
	               |	МАКСИМУМ(КоэффПеревода),
	               |	МАКСИМУМ(Цена),
	               |	МАКСИМУМ(КомментарийСУ),
	               |	МАКСИМУМ(ИсключениеСУ),
	               |	МАКСИМУМ(ЦенаЗаШтукуСУ),
	               |	МАКСИМУМ(ЕстьИзмененияВБудущемПериодеСУ)
	               |ПО
	               |	Поставщик,
	               |	Номенклатура
	               |АВТОУПОРЯДОЧИВАНИЕ";
	
	Если ПраздничныйГрафик Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ВЫБОРГРАФИК","РегистрСведений.ГрафикЗаказовИПоставокПраздничный КАК ГрафикЗаказа");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "//ВЫБОРГРАФИК","РегистрСведений.ГрафикЗаказовИПоставок КАК ГрафикЗаказа");
	КонецЕсли;

	Запрос.УстановитьПараметр("ТекДата", Дата);
	Запрос.УстановитьПараметр("ДатаБудущего", Дата + 60*60*24*14);  // проверяем на 14 дней вперед
	Запрос.УстановитьПараметр("Организация", ?(ЗначениеЗаполнено(Организация), Организация, Неопределено));
	Запрос.УстановитьПараметр("Номенклатура", ?(ЗначениеЗаполнено(Номенклатура), Номенклатура, Неопределено));
	Запрос.УстановитьПараметр("Контрагент", ?(ЗначениеЗаполнено(Поставщик), Поставщик, Неопределено));

	
	Возврат Запрос.Выполнить().Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
КонецФункции

